name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: kivy/buildozer:latest

    steps:
      - uses: actions/checkout@v4

      - name: Create main.py
        run: |
          echo 'from kivy.app import App' > main.py
          echo 'from kivy.uix.boxlayout import BoxLayout' >> main.py
          echo 'from kivy.uix.label import Label' >> main.py
          echo 'from kivy.uix.textinput import TextInput' >> main.py
          echo 'from kivy.uix.button import Button' >> main.py
          echo 'from kivy.uix.scrollview import ScrollView' >> main.py
          echo 'from kivy.core.window import Window' >> main.py
          echo 'from kivy.clock import Clock' >> main.py
          echo 'from kivy.metrics import dp' >> main.py
          echo 'from kivy.graphics import Color, RoundedRectangle' >> main.py
          echo '' >> main.py
          echo 'Window.clearcolor = (0.1, 0.1, 0.1, 1)' >> main.py
          echo '' >> main.py
          echo 'class MessageBubble(BoxLayout):' >> main.py
          echo '    def __init__(self, text, is_user=True, **kwargs):' >> main.py
          echo '        super().__init__(**kwargs)' >> main.py
          echo '        self.orientation = "horizontal"' >> main.py
          echo '        self.size_hint_y = None' >> main.py
          echo '        self.padding = [dp(10), dp(5)]' >> main.py
          echo '        self.spacing = dp(10)' >> main.py
          echo '' >> main.py
          echo '        bubble_color = (0.1, 0.4, 0.6, 1) if is_user else (0.2, 0.3, 0.4, 1)' >> main.py
          echo '        halign = "right" if is_user else "left"' >> main.py
          echo '' >> main.py
          echo '        with self.canvas.before:' >> main.py
          echo '            Color(*bubble_color)' >> main.py
          echo '            self.rect = RoundedRectangle(pos=self.pos, size=self.size, radius=[dp(10)])' >> main.py
          echo '' >> main.py
          echo '        self.label = Label(' >> main.py
          echo '            text=text,' >> main.py
          echo '            size_hint=(None, 1),' >> main.py
          echo '            width=dp(280),' >> main.py
          echo '            text_size=(dp(270), None),' >> main.py
          echo '            halign=halign,' >> main.py
          echo '            valign="middle",' >> main.py
          echo '            color=(1, 1, 1, 1)' >> main.py
          echo '        )' >> main.py
          echo '        self.label.bind(texture_size=self.label.setter("size"))' >> main.py
          echo '        self.add_widget(self.label)' >> main.py
          echo '        self.bind(pos=self.update_rect, size=self.update_rect)' >> main.py
          echo '' >> main.py
          echo '    def update_rect(self, *args):' >> main.py
          echo '        self.rect.pos = self.pos' >> main.py
          echo '        self.rect.size = self.size' >> main.py
          echo '' >> main.py
          echo 'class ChatApp(App):' >> main.py
          echo '    def build(self):' >> main.py
          echo '        main = BoxLayout(orientation="vertical", padding=dp(10), spacing=dp(10))' >> main.py
          echo '' >> main.py
          echo '        self.scroll = ScrollView()' >> main.py
          echo '        self.chat_area = BoxLayout(orientation="vertical", size_hint_y=None, spacing=dp(5))' >> main.py
          echo '        self.chat_area.bind(minimum_height=self.chat_area.setter("height"))' >> main.py
          echo '        self.scroll.add_widget(self.chat_area)' >> main.py
          echo '' >> main.py
          echo '        bottom = BoxLayout(size_hint_y=None, height=dp(50), spacing=dp(10))' >> main.py
          echo '        self.input = TextInput(' >> main.py
          echo '            multiline=False,' >> main.py
          echo '            hint_text="Type your message...",' >> main.py
          echo '            background_color=(0.2, 0.2, 0.2, 1),' >> main.py
          echo '            foreground_color=(1, 1, 1, 1)' >> main.py
          echo '        )' >> main.py
          echo '        self.input.bind(on_text_validate=self.send_message)' >> main.py
          echo '' >> main.py
          echo '        send_btn = Button(' >> main.py
          echo '            text="Send",' >> main.py
          echo '            size_hint_x=None,' >> main.py
          echo '            width=dp(70),' >> main.py
          echo '            background_color=(0.2, 0.6, 1, 1)' >> main.py
          echo '        )' >> main.py
          echo '        send_btn.bind(on_release=self.send_message)' >> main.py
          echo '' >> main.py
          echo '        bottom.add_widget(self.input)' >> main.py
          echo '        bottom.add_widget(send_btn)' >> main.py
          echo '' >> main.py
          echo '        main.add_widget(self.scroll)' >> main.py
          echo '        main.add_widget(bottom)' >> main.py
          echo '' >> main.py
          echo '        self.add_message("Hello! How can I help you?", False)' >> main.py
          echo '        return main' >> main.py
          echo '' >> main.py
          echo '    def send_message(self, instance):' >> main.py
          echo '        msg = self.input.text.strip()' >> main.py
          echo '        if not msg:' >> main.py
          echo '            return' >> main.py
          echo '        self.add_message(msg, True)' >> main.py
          echo '        self.input.text = ""' >> main.py
          echo '        Clock.schedule_once(lambda dt: self.get_response(msg), 0.8)' >> main.py
          echo '' >> main.py
          echo '    def get_response(self, msg):' >> main.py
          echo '        lower = msg.lower()' >> main.py
          echo '' >> main.py
          echo '        if any(word in lower for word in ["hello", "hi", "hey"]):' >> main.py
          echo '            response = "Hello! How are you?"' >> main.py
          echo '        elif any(word in lower for word in ["how are you", "how do you do"]):' >> main.py
          echo '            response = "I am good, thanks! How about you?"' >> main.py
          echo '        elif any(word in lower for word in ["good", "great", "fine"]):' >> main.py
          echo '            response = "Glad to hear that!"' >> main.py
          echo '        elif any(word in lower for word in ["bye", "goodbye"]):' >> main.py
          echo '            response = "Goodbye! Have a nice day!"' >> main.py
          echo '        elif any(word in lower for word in ["thanks", "thank you"]):' >> main.py
          echo '            response = "You are welcome!"' >> main.py
          echo '        else:' >> main.py
          echo '            response = "Interesting! Tell me more."' >> main.py
          echo '' >> main.py
          echo '        self.add_message(response, False)' >> main.py
          echo '' >> main.py
          echo '    def add_message(self, text, is_user):' >> main.py
          echo '        bubble = MessageBubble(text=text, is_user=is_user)' >> main.py
          echo '        self.chat_area.add_widget(bubble)' >> main.py
          echo '        Clock.schedule_once(lambda dt: setattr(self.scroll, "scroll_y", 0), 0.1)' >> main.py
          echo '' >> main.py
          echo 'if __name__ == "__main__":' >> main.py
          echo '    ChatApp().run()' >> main.py

      - name: Create buildozer.spec
        run: |
          echo '[app]' > buildozer.spec
          echo 'title = My ChatGPT' >> buildozer.spec
          echo 'package.name = mychatbot' >> buildozer.spec
          echo 'package.domain = org.example' >> buildozer.spec
          echo 'source.dir = .' >> buildozer.spec
          echo 'source.include_exts = py,png,jpg,kv,atlas' >> buildozer.spec
          echo 'version = 0.1' >> buildozer.spec
          echo 'requirements = python3,kivy==2.1.0' >> buildozer.spec
          echo 'orientation = portrait' >> buildozer.spec
          echo 'fullscreen = 0' >> buildozer.spec
          echo '' >> buildozer.spec
          echo '[buildozer]' >> buildozer.spec
          echo 'log_level = 2' >> buildozer.spec
          echo 'android.accept_sdk_license = True' >> buildozer.spec
          echo 'android.ndk = 25b' >> buildozer.spec
          echo 'android.sdk = 24' >> buildozer.spec
          echo 'android.minapi = 21' >> buildozer.spec
          echo 'android.api = 31' >> buildozer.spec
          echo 'android.arch = arm64-v8a' >> buildozer.spec

      - name: Build APK
        run: |
          yes | buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: my-chatbot-apk
          path: bin/*.apk
